---
title: "Fees2023"
output: html_document
date: "2024-07-09"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## R Markdown

This is an R Markdown document. Markdown is a simple formatting syntax for authoring HTML, PDF, and MS Word documents. For more details on using R Markdown see <http://rmarkdown.rstudio.com>.

When you click the **Knit** button a document will be generated that includes both content as well as the output of any embedded R code chunks within the document. You can embed an R code chunk like this:

```{r pulling the data from folder, and cleaning}
library(tidyverse)
library(lubridate)

data_path <- "data"   # path to the data
files <- dir(data_path, pattern = "\\.csv$", full.names = TRUE)

READ <- function(FILE) {
  read_csv(FILE,
           trim_ws = TRUE,
           guess_max = nrow(read_csv(FILE)) -12,
           n_max = nrow(read_csv(FILE)) -12,
           # col_types = cols(
           #   `Inception \nDate` = col_date("%m/%d/%Y"),
           #   `Listing \nDate`= col_date("%m/%d/%Y")
           # )
        ) %>%
    mutate(filename = basename(FILE)) %>%
    rename_all(make.names)
}

data <- files %>%
  map(READ) %>%    # read in all the files individually, using
  # the function READ from above
  reduce(full_join, by=)        # reduce with full_join into one dataframe

warnings <- warnings(data)

write_csv(data, "results/general/data_combined.csv")

```


Final tally after following code: 19,057 rows, 197 columns
```{r Data adjustments  }
?
library(tidyverse)
library(lubridate)


full <- read_csv("results/general/data_combined.csv",
                 guess_max = 20000)


Adjusted_Data <- full %>%
  rename_all(make.names) %>%
  filter(Fund.of..Funds != "Yes",
         US.Category.Group != "Money Market" | is.na(US.Category.Group),
         is.na(Obsolete..Date)
  ) %>%
  mutate(
    Firm.Name.Mod = case_when(
      Branding.Name == "iShares" ~ "BlackRock",
      Branding.Name == "SPDR State Street Global Advisors" ~ "State Street Global Advisors",
      Branding.Name == "Calvert Research and Management" ~ "Morgan Stanley",
      Branding.Name == "Eaton Vance" ~ "Morgan Stanley",
      Branding.Name == "Nuveen" ~ "TIAA Investments",
      Branding.Name %in% c("Harding Loevner", "Third Avenue", "Tweedy, Browner") ~ "AMG",
      Branding.Name %in% "Amundi" ~ "Pioneer Investments",
      grepl("AllianzGI", Name) ~ "AllianzGI_",
      TRUE ~ as.character(Firm.Name)
    )
  ) %>%
  mutate(
    Net_Asst_2021_AVG = rowMeans(.[, 152:163], na.rm = TRUE),
    Net_Asst_2022_AVG = rowMeans(.[, 164:175], na.rm = TRUE),
    Net_Asst_2023_AVG = rowMeans(.[, 176:187], na.rm = TRUE),
    Asst_By_Fee_2021 = Net_Asst_2021_AVG * Annual.Report.Adjusted.Expense.Ratio..Year2021,
    Asst_By_Fee_2022 = Net_Asst_2022_AVG * Annual.Report.Adjusted.Expense.Ratio..Year2022,
    Asst_By_Fee_2023 = Net_Asst_2023_AVG * Annual.Report.Adjusted.Expense.Ratio..Year2023,
    Pct_Change_2021_2022 = (
      Annual.Report.Adjusted.Expense.Ratio..Year2022 - Annual.Report.Adjusted.Expense.Ratio..Year2021
    ) / Annual.Report.Adjusted.Expense.Ratio..Year2021 * 100,
    Pct_Change_2022_2023 = (
      Annual.Report.Adjusted.Expense.Ratio..Year2023 - Annual.Report.Adjusted.Expense.Ratio..Year2022
    ) / Annual.Report.Adjusted.Expense.Ratio..Year2022 * 100
  )

write_csv(Adjusted_Data,
          "results/general/MF_Fee_Report_20240710_ag.csv")

```


```{Active funds}


ActiveFunds <- Adjusted_Data %>%
  filter(
    Net_Asst_2023_AVG != 0 &
      Index..Fund != "Yes" &
      !is.na(Annual.Report.Adjusted.Expense.Ratio..Year2023) &
      Investment.Type == "Open-End Fund"
  ) %>%
  group_by(Firm.Name.Mod) %>%
  mutate(
    Count = n(),
    Sum_Assets_2023 = sum(Net_Asst_2023_AVG, na.rm = TRUE)
  ) %>%
  ungroup() %>% 
  filter(Count >= 50 &
           Sum_Assets_2023 >= 2.5e+10
  )

summaryinfo <- function(x) {
  summarise(x,
            Count = n(),
            Sum_Assts_Wted_2021 = sum(Asst_By_Fee_2021, na.rm = TRUE),
            Sum_Assets_2021 = sum(Net_Asst_2021_AVG, na.rm = TRUE),
            Fee_Wted_2021 = Sum_Assts_Wted_2021 / Sum_Assets_2021,
            Sum_Assts_Wted_2022 = sum(Asst_By_Fee_2022, na.rm = TRUE),
            Sum_Assets_2022 = sum(Net_Asst_2022_AVG, na.rm = TRUE),
            Fee_Wted_2022 = Sum_Assts_Wted_2022 / Sum_Assets_2022,
            Sum_Assts_Wted_2023 = sum(Asst_By_Fee_2023, na.rm = TRUE),
            Sum_Assets_2023 = sum(Net_Asst_2023_AVG, na.rm = TRUE),
            Fee_Wted_2023 = Sum_Assts_Wted_2023 / Sum_Assets_2023
  )
}

Active_Fees <- ActiveFunds %>%
  group_by(Firm.Name.Mod) %>%
  summaryinfo()

write_csv(Active_Fees,
          "results/active/fees_activefunds_firm.csv")

Active_HighFees <- Active_Fees %>%
  arrange(desc(Fee_Wted_2023)) %>%
  top_n(10, Fee_Wted_2023)

Active_LowFees <- Active_Fees %>%
  arrange(Fee_Wted_2023) %>%
  top_n(-10, Fee_Wted_2023)
```


```{summary data for active funds}

Active_Summary <- ActiveFunds %>% 
  ungroup() %>%
  summaryinfo() %>%
  select(
    1,
    3:4,
    6:7,
    9:10
  ) %>% 
  gather(
    key = "Field",
    value, "Count",
    2:7
  )

write_csv(Active_Summary,
          "results/active/fees_activefunds_summary.csv")
```

```{Fees by Type of Active Fund Category}

Active_Cat <- ActiveFunds %>% 
  group_by(Firm.Name.Mod, US.Category.Group) %>% 
  summarise(
    Asst_Wted_Cat_2021 = sum(Asst_By_Fee_2021, na.rm = TRUE),
    Sum_Assets_Cat_2021 = sum(Net_Asst_2021_AVG, na.rm = TRUE),
    Fee_Wted_Cat_2021 = Asst_Wted_Cat_2021 / Sum_Assets_Cat_2021,
    Asst_Wted_Cat_2022 = sum(Asst_By_Fee_2022, na.rm = TRUE),
    Sum_Assets_Cat_2022 = sum(Net_Asst_2022_AVG, na.rm = TRUE),
    Fee_Wted_Cat_2022 = Asst_Wted_Cat_2022 / Sum_Assets_Cat_2022,
    Asst_Wted_Cat_2023 = sum(Asst_By_Fee_2023, na.rm = TRUE),
    Sum_Assets_Cat_2023 = sum(Net_Asst_2023_AVG, na.rm = TRUE),
    Fee_Wted_Cat_2023 = Asst_Wted_Cat_2023 / Sum_Assets_Cat_2023,
    Cat_Count = n()
  ) %>% 
  group_by(Firm.Name.Mod) %>% 
  mutate(
    ShareClass_Count = sum(Cat_Count, na.rm = TRUE),
    Sum_Assts_Wted_2022 = sum(Asst_Wted_Cat_2022, na.rm = TRUE),
    Sum_Assets_2022 = sum(Sum_Assets_Cat_2022, na.rm = TRUE),
    Fee_Wted_2022 = Sum_Assts_Wted_2022 / Sum_Assets_2022,
    pct_assets_2022 = (Sum_Assets_Cat_2022 / Sum_Assets_2022) * 100,
    Sum_Assts_Wted_2023 = sum(Asst_Wted_Cat_2023, na.rm = TRUE),
    Sum_Assets_2023 = sum(Sum_Assets_Cat_2023, na.rm = TRUE),
    Fee_Wted_2023 = Sum_Assts_Wted_2023 / Sum_Assets_2023,
    pct_assets_2023 = (Sum_Assets_Cat_2023 / Sum_Assets_2023) * 100
  )

write_csv(Active_Cat,
          "results/active/cat_activefunds_firm.csv")

Active_Cat_Sum <- Active_Cat %>%
  group_by(US.Category.Group) %>%  
  summarise(
    SHARECLASSES = sum(Cat_Count),
    FEE = round((sum(Asst_Wted_Cat_2023)/sum(Sum_Assets_Cat_2023)),2),
    ASSETS = sum(Sum_Assets_Cat_2023)
  ) %>%  
  mutate(
    pct = round(ASSETS / sum(ASSETS)*100,2)
  )

Lowcost_Active_Firms <- Active_LowFees$Firm.Name.Mod
Highcost_Active_Firms <- Active_HighFees$Firm.Name.Mod

Active_Cat_Pct <- Active_Cat %>%
  select(
    Firm.Name.Mod,
    US.Category.Group,
    Cat_Count,
    Sum_Assets_Cat_2023,
    Sum_Assets_2023,
    Fee_Wted_Cat_2023,
    Fee_Wted_2023,
    pct_assets_2023
  ) %>%
  mutate(Type =
           case_when(
             grepl("Equity", US.Category.Group) ~ "Equity",
             grepl("Bond", US.Category.Group) ~ "Bond",
             TRUE ~ "Other"
           )) %>%
  # filter(Firm.Name.Mod %in% Lowcost_Active_Firms |
  #          Firm.Name.Mod %in% Highcost_Active_Firms) %>%
  # group_by(Firm.Name.Mod) %>%
  arrange(-Fee_Wted_2023, .by_group = TRUE)

write_csv(Active_Cat_Pct,
          "results/active/cat_activefunds_highlow.csv")
```

```{Fees by Type of Morningstar Fund Category (ACTIVE)}
Active_MSCat <- ActiveFunds %>% 
  group_by(Firm.Name.Mod, Morningstar.Category) %>% 
  summarise(
    Asst_Wted_Cat_2022 = sum(Asst_By_Fee_2022, na.rm = TRUE),
    Sum_Assets_Cat_2022 = sum(Net_Asst_2022_AVG, na.rm = TRUE),
    Fee_Wted_Cat_2022 = Asst_Wted_Cat_2022 / Sum_Assets_Cat_2022,
    Asst_Wted_Cat_2023 = sum(Asst_By_Fee_2023, na.rm = TRUE),
    Sum_Assets_Cat_2023 = sum(Net_Asst_2023_AVG, na.rm = TRUE),
    Fee_Wted_Cat_2023 = Asst_Wted_Cat_2023 / Sum_Assets_Cat_2023,
    Cat_Count = n()
  ) %>% 
  group_by(Firm.Name.Mod) %>% 
  mutate(
    ShareClass_Count = sum(Cat_Count, na.rm = TRUE),
    Sum_Assts_Wted_2022 = sum(Asst_Wted_Cat_2022, na.rm = TRUE),
    Sum_Assets_2022 = sum(Sum_Assets_Cat_2022, na.rm = TRUE),
    Fee_Wted_2022 = Sum_Assts_Wted_2022 / Sum_Assets_2022,
    pct_assets_2022 = (Sum_Assets_Cat_2022 / Sum_Assets_2022) * 100,
    Sum_Assts_Wted_2023 = sum(Asst_Wted_Cat_2023, na.rm = TRUE),
    Sum_Assets_2023 = sum(Sum_Assets_Cat_2023, na.rm = TRUE),
    Fee_Wted_2023 = Sum_Assts_Wted_2023 / Sum_Assets_2023,
    pct_assets_2023 = (Sum_Assets_Cat_2023 / Sum_Assets_2023) * 100
  )

write_csv(Active_MSCat,
          "results/active/MScat_activefunds.csv")


Active_MSCat_Sum <- Active_MSCat %>%
  group_by(Morningstar.Category) %>%  
  summarise(
    SHARECLASSES = sum(Cat_Count),
    FEE = round((sum(Asst_Wted_Cat_2023)/sum(Sum_Assets_Cat_2023)),2),
    ASSETS = sum(Sum_Assets_Cat_2023)
  ) %>%  
  mutate(
    pct = round(ASSETS / sum(ASSETS)*100,2),
    RANK = rank(-FEE)
  )

Lowcost_Active_Firms <- Active_LowFees$Firm.Name.Mod
Highcost_Active_Firms <- Active_HighFees$Firm.Name.Mod

Active_MSCat_Pct <- Active_MSCat %>%
  select(
    Firm.Name.Mod,
    Morningstar.Category,
    Cat_Count,
    Sum_Assets_Cat_2023,
    Sum_Assets_2023,
    Fee_Wted_Cat_2023,
    Fee_Wted_2023,
    pct_assets_2023
  ) %>%
  filter(Firm.Name.Mod %in% Lowcost_Active_Firms |
           Firm.Name.Mod %in% Highcost_Active_Firms) %>%
  group_by(Firm.Name.Mod) %>%
  arrange(-Fee_Wted_2023, .by_group = TRUE)

write_csv(Active_MSCat_Pct,
          "results/active/MScat_activefunds_highlow.csv")
```

```{Fee changes among active share classes}
Active_Shareclass <- Adjusted_Data %>%
  filter(
    Annual.Report.Adjusted.Expense.Ratio..Year2022 != 0 &
      !is.na(Annual.Report.Adjusted.Expense.Ratio..Year2022) &
      !is.na(Annual.Report.Adjusted.Expense.Ratio..Year2023) &
      Index..Fund == "No" &
      Investment.Type == "Open-End Fund"
  ) %>%
  mutate(
    FeeChange =
      cut(
        Pct_Change_2022_2023,
        breaks = c(-Inf,-0.001, 0, Inf),
        labels = c("Cut", "No Change", "Hike"),
        include.lowest = TRUE,
        right = TRUE
      )
  )

Active_Summary_Shareclass <- Active_Shareclass %>%
  group_by(Firm.Name.Mod,
           FeeChange) %>%
  summarise(count = n(),
            Sum_Assets = sum(Net_Asst_2023_AVG, na.rm = TRUE)
  ) %>%
  group_by(Firm.Name.Mod) %>%
  mutate(
    total_assets = sum(Sum_Assets),
    assets_pct = Sum_Assets / total_assets * 100,
    total_count = sum(count),
    count_pct = count / total_count * 100
  ) %>%
  filter(total_count >= 50 &
           total_assets >= 2.5e+10
  )

## `summarise()` has grouped output by 'Firm.Name.Mod'. You can override using the
## `.groups` argument.

write_csv(
  Active_Summary_Shareclass,
  "results/active/shareclass_changes_activefunds.csv"
)
```
## Including Plots

You can also embed plots, for example:

# ```{r pressure, echo=FALSE}
# plot(pressure)
# ```

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
